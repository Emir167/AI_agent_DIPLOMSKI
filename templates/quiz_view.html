{% extends 'base.html' %}
{% block content %}
<h2 class="d-flex align-items-center gap-3">
  {{ quiz.title }}
  {% if score is defined %}
    <span class="badge bg-info">Result: {{ score }}/{{ quiz.questions|length }} ({{ percent }}%)</span>
  {% endif %}
</h2>
{% if provider or chunk_preview %}
  <div class="alert alert-light border d-flex justify-content-between align-items-center">
    <div>
      <strong>Provider:</strong> {{ provider or 'n/a' }}
      {% if chunk_preview %}
        <br><strong>Source chunk (preview):</strong>
        <span class="text-muted">{{ chunk_preview }}{% if chunk_preview and chunk_preview|length >= 400 %}â€¦{% endif %}</span>
      {% endif %}
    </div>
    <span class="badge bg-secondary">Grounded</span>
  </div>
{% endif %}

{% if score is defined %}
<div class="alert alert-secondary">
  <strong>Quiz Complete!</strong>
  <div class="display-6">{{ score }}/{{ quiz.questions|length }}</div>
  <div>{{ percent }}%</div>
</div>
{% endif %}

<form method="post" action="{{ url_for('quiz_grade', quiz_id=quiz.id) }}">
  {% for q in quiz.questions %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Question {{ loop.index }}</div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-secondary text-capitalize">{{ q.kind }}</span>
          <span class="badge bg-light text-dark text-capitalize">{{ q.difficulty }}</span>
          {% if score is defined and details %}
            {% set det = details.get(q.id) %}
            {% if det and det.ok %}
              <span class="badge bg-success">Correct</span>
            {% elif det %}
              <span class="badge bg-danger">Incorrect</span>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <p class="mt-2 mb-3">{{ q.prompt }}</p>

      {% if q.kind in ['mcq','tf'] %}
        {% set opts = (q.options or '').split('|') %}
        {% for opt in opts %}
          {% set letter = (opt.split(')')[0] or '').strip() %}
          <div class="form-check">
            <input class="form-check-input" type="radio"
                   name="q_{{ q.id }}"
                   value="{{ letter }}"
                   id="q{{ q.id }}_{{ loop.index }}"
                   {% if answers and answers.get(q.id)|default('') == letter %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}_{{ loop.index }}">{{ opt }}</label>
          </div>
        {% endfor %}
      {% elif q.kind in ['short','fill'] %}
        <input class="form-control" type="text" name="q_{{ q.id }}"
               placeholder="{% if q.kind == 'fill' %}Enter the missing word(s)...{% else %}Your answer...{% endif %}"
               value="{{ answers.get(q.id) if answers else '' }}">
      {% endif %}

      {% if score is defined %}
        {% set user = answers.get(q.id) if answers else '' %}
        {% set det = details.get(q.id) if details else None %}
        <div class="mt-3 p-3 border rounded
            {% if det and det.ok %}border-success{% else %}border-danger{% endif %}">
          <div><strong>Correct Answer:</strong> {{ q.correct_answer }}</div>
          {% if q.explanation %}
            <div><strong>Explanation:</strong> {{ q.explanation }}</div>
          {% endif %}
          {% if det %}
            <div class="mt-2 small text-muted">
              <strong>{% if det.ai %}AI judge{% else %}Rule-based{% endif %}:</strong> {{ det.reason }}
            </div>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  {% if score is not defined %}
    <button class="btn btn-primary">Submit Quiz</button>
  {% else %}
    <a class="btn btn-outline-primary" href="{{ url_for('quiz_view', quiz_id=quiz.id) }}">Retake Quiz</a>
  {% endif %}
</form>
{% endblock %}
